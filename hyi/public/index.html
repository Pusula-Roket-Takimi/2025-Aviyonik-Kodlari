<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Yer Ä°stasyonu - Node.js Client</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; }
  h2 { border-bottom: 2px solid #555; padding-bottom: 4px; }
  select, button { font-size: 1rem; margin: 5px; padding: 5px 10px; }
  select { min-width: 200px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 30px; background: #222; }
  th, td { border: 1px solid #444; padding: 6px 10px; text-align: left; }
  th { background: #333; }
  #log { background: #222; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; margin-top: 20px; border: 1px solid #444; }
  .connection-group { margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 5px; }
  .connection-status { display: inline-block; margin-left: 10px; padding: 3px 8px; border-radius: 3px; font-size: 0.9em; }
  .connected { background: #28a745; color: white; }
  .disconnected { background: #dc3545; color: white; }
  .connecting { background: #ffc107; color: black; }
  .refresh-btn { background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
  .refresh-btn:hover { background: #138496; }
  
  /* 3D ve Harita iÃ§in yeni stiller */
  .visualization-container { 
    display: flex; 
    gap: 20px; 
    margin: 20px 0; 
    height: 400px; 
  }
  .rocket-3d { 
    flex: 1; 
    background: #1a1a1a; 
    border: 1px solid #444; 
    border-radius: 5px; 
    position: relative; 
  }
  .map-container { 
    flex: 1; 
    background: #1a1a1a; 
    border: 1px solid #444; 
    border-radius: 5px; 
    position: relative; 
  }
  #rocketCanvas { 
    width: 100%; 
    height: 100%; 
    display: block; 
  }
  #map { 
    width: 100%; 
    height: 100%; 
  }
  .info-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
  }
</style>
</head>
<body>

<h1>Pusula Roket TakÄ±mÄ± Yer Ä°stasyonu</h1>

<div class="connection-group">
  <h3>Aviyonik BaÄŸlantÄ±sÄ±</h3>
  <select id="aviyonikPortSelect">
    <option value="">Port seÃ§in...</option>
  </select>
  <button id="connectAviyonikBtn">BaÄŸlan</button>
  <button id="disconnectAviyonikBtn" disabled>BaÄŸlantÄ±yÄ± Kes</button>
  <button class="refresh-btn" id="refreshPortsBtn">PortlarÄ± Yenile</button>
  <span id="aviyonikStatus" class="connection-status disconnected">BaÄŸlÄ± DeÄŸil</span>
</div>

<div class="connection-group">
  <h3>GÃ¶rev YÃ¼kÃ¼ BaÄŸlantÄ±sÄ±</h3>
  <select id="gorevPortSelect">
    <option value="">Port seÃ§in...</option>
  </select>
  <button id="connectGorevBtn">BaÄŸlan</button>
  <button id="disconnectGorevBtn" disabled>BaÄŸlantÄ±yÄ± Kes</button>
  <span id="gorevStatus" class="connection-status disconnected">BaÄŸlÄ± DeÄŸil</span>
</div>

<div class="connection-group">
  <h3>HYÄ° BaÄŸlantÄ±sÄ±</h3>
  <select id="hyiPortSelect">
    <option value="">Port seÃ§in...</option>
  </select>
  <button id="connectHYIBtn">BaÄŸlan</button>
  <button id="disconnectHYIBtn" disabled>BaÄŸlantÄ±yÄ± Kes</button>
  <span id="hyiStatus" class="connection-status disconnected">BaÄŸlÄ± DeÄŸil</span>
</div>

<!-- 3D Roket ve Harita GÃ¶rÃ¼nÃ¼mÃ¼ -->
<div class="visualization-container">
  <div class="rocket-3d">
    <div class="info-panel">
      <div>Roket AÃ§Ä±sÄ±: <span id="rocketAngle">0Â°</span></div>
      <div>Ä°rtifa: <span id="rocketAltitude">0 m</span></div>
    </div>
    <canvas id="rocketCanvas"></canvas>
  </div>
  <div class="map-container">
    <div class="info-panel">
      <div>Enlem: <span id="rocketLat">0Â°</span></div>
      <div>Boylam: <span id="rocketLng">0Â°</span></div>
    </div>
    <div id="map"></div>
  </div>
</div>

<h2>Aviyonik Verisi</h2>
<table id="aviyonikTable"><thead><tr><th>Parametre</th><th>DeÄŸer</th></tr></thead><tbody></tbody></table>

<h2>GÃ¶rev YÃ¼kÃ¼ Verisi</h2>
<table id="gorevTable"><thead><tr><th>Parametre</th><th>DeÄŸer</th></tr></thead><tbody></tbody></table>

<h2>Ä°statistikler</h2>
<div style="display: flex; gap: 20px; margin-bottom: 20px;">
  <div>Aviyonik Paketi: <span id="aviyonikCount">0</span></div>
  <div>GÃ¶rev YÃ¼kÃ¼ Paketi: <span id="gorevCount">0</span></div>
  <div>HYÄ° GÃ¶nderildi: <span id="hyiCount">0</span></div>
</div>

<h2>Log</h2>
<div id="log"></div>

<script>
const socket = new WebSocket(`ws://${location.host}`);

// Veri saklama
let lastAviyonikData = {};
let lastGorevData = {};

// SayaÃ§lar
let aviyonikPacketCount = 0;
let gorevPacketCount = 0;
let hyiSentCount = 0;

// 3D Roket iÃ§in deÄŸiÅŸkenler
let scene, camera, renderer, rocket;
let rocketAngle = 0;

// Harita iÃ§in deÄŸiÅŸkenler
let map, rocketMarker;
let rocketLat = 39.9334, rocketLng = 32.8597; // Ankara koordinatlarÄ± (varsayÄ±lan)

// DOM elementleri
const logDiv = document.getElementById('log');
const aviyonikTableBody = document.querySelector('#aviyonikTable tbody');
const gorevTableBody = document.querySelector('#gorevTable tbody');
const aviyonikStatus = document.getElementById('aviyonikStatus');
const gorevStatus = document.getElementById('gorevStatus');
const hyiStatus = document.getElementById('hyiStatus');

const aviyonikPortSelect = document.getElementById('aviyonikPortSelect');
const gorevPortSelect = document.getElementById('gorevPortSelect');
const hyiPortSelect = document.getElementById('hyiPortSelect');

const aviyonikCountSpan = document.getElementById('aviyonikCount');
const gorevCountSpan = document.getElementById('gorevCount');
const hyiCountSpan = document.getElementById('hyiCount');

// 3D ve Harita elementleri
const rocketCanvas = document.getElementById('rocketCanvas');
const mapDiv = document.getElementById('map');
const rocketAngleSpan = document.getElementById('rocketAngle');
const rocketAltitudeSpan = document.getElementById('rocketAltitude');
const rocketLatSpan = document.getElementById('rocketLat');
const rocketLngSpan = document.getElementById('rocketLng');

function log(msg) {
  const timestamp = new Date().toLocaleTimeString();
  logDiv.innerHTML += `[${timestamp}] ${msg}<br>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

function updateStatus(element, status) {
  element.className = `connection-status ${status}`;
  switch(status) {
    case 'connected':
      element.textContent = 'BaÄŸlÄ±';
      break;
    case 'connecting':
      element.textContent = 'BaÄŸlanÄ±yor...';
      break;
    case 'disconnected':
    default:
      element.textContent = 'BaÄŸlÄ± DeÄŸil';
      break;
  }
}

function updateCounts() {
  aviyonikCountSpan.textContent = aviyonikPacketCount;
  gorevCountSpan.textContent = gorevPacketCount;
  hyiCountSpan.textContent = hyiSentCount;
}

// 3D Roket BaÅŸlatma
function init3DRocket() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x1a1a1a);
  
  camera = new THREE.PerspectiveCamera(75, rocketCanvas.clientWidth / rocketCanvas.clientHeight, 0.1, 1000);
  camera.position.set(0, 5, 10);
  
  renderer = new THREE.WebGLRenderer({ canvas: rocketCanvas, antialias: true });
  renderer.setSize(rocketCanvas.clientWidth, rocketCanvas.clientHeight);
  
  // IÅŸÄ±k ekle
  const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
  scene.add(ambientLight);
  
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(10, 10, 5);
  scene.add(directionalLight);
  
  // Roket oluÅŸtur
  createRocket();
  
  animate();
}

function createRocket() {
  const rocketGroup = new THREE.Group();
  
  // Roket gÃ¶vdesi (silindir)
  const bodyGeometry = new THREE.CylinderGeometry(0.5, 0.5, 6, 8);
  const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
  const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
  body.position.y = 3;
  rocketGroup.add(body);
  
  // Roket burnu (koni)
  const noseGeometry = new THREE.ConeGeometry(0.5, 1, 8);
  const noseMaterial = new THREE.MeshPhongMaterial({ color: 0xff4444 });
  const nose = new THREE.Mesh(noseGeometry, noseMaterial);
  nose.position.y = 6.5;
  rocketGroup.add(nose);
  
  // Kanatlar
  const wingGeometry = new THREE.BoxGeometry(0.1, 0.8, 1.5);
  const wingMaterial = new THREE.MeshPhongMaterial({ color: 0x4444ff });
  
  for (let i = 0; i < 4; i++) {
    const wing = new THREE.Mesh(wingGeometry, wingMaterial);
    const angle = (i * Math.PI) / 2;
    wing.position.set(
      Math.cos(angle) * 0.8,
      1,
      Math.sin(angle) * 0.8
    );
    wing.rotation.y = angle;
    rocketGroup.add(wing);
  }
  
  rocket = rocketGroup;
  scene.add(rocket);
}

function animate() {
  requestAnimationFrame(animate);
  
  // Roketi dÃ¶ndÃ¼r
  if (rocket) {
    rocket.rotation.z = rocketAngle * Math.PI / 180;
  }
  
  renderer.render(scene, camera);
}

// Harita BaÅŸlatma
function initMap() {
  map = L.map('map').setView([rocketLat, rocketLng], 13);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);
  
  // Roket marker'Ä±
  rocketMarker = L.marker([rocketLat, rocketLng], {
    icon: L.divIcon({
      className: 'rocket-marker',
      html: 'ðŸš€',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    })
  }).addTo(map);
}

// Roket verilerini gÃ¼ncelle
function updateRocketVisualization(data) {
  if (data.aci !== undefined) {
    rocketAngle = data.aci;
    rocketAngleSpan.textContent = `${rocketAngle.toFixed(1)}Â°`;
  }
  
  if (data.roket_irtifa !== undefined) {
    rocketAltitudeSpan.textContent = `${data.roket_irtifa.toFixed(1)} m`;
  }
  
  if (data.roket_enlem !== undefined && data.roket_boylam !== undefined) {
    rocketLat = data.roket_enlem;
    rocketLng = data.roket_boylam;
    
    rocketLatSpan.textContent = `${rocketLat.toFixed(6)}Â°`;
    rocketLngSpan.textContent = `${rocketLng.toFixed(6)}Â°`;
    
    if (rocketMarker) {
      rocketMarker.setLatLng([rocketLat, rocketLng]);
      map.setView([rocketLat, rocketLng]);
    }
  }
}

// WebSocket event listeners
document.addEventListener('DOMContentLoaded', () => {
  // 3D ve Harita baÅŸlat
  init3DRocket();
  initMap();
  
  socket.addEventListener('open', () => {
    log('Sunucuya baÄŸlanÄ±ldÄ±');
  });

  socket.addEventListener('close', () => {
    log('Sunucu baÄŸlantÄ±sÄ± koptu');
    updateStatus(aviyonikStatus, 'disconnected');
    updateStatus(gorevStatus, 'disconnected');
    updateStatus(hyiStatus, 'disconnected');
  });

  socket.addEventListener('message', (event) => {
    let msg;
    try {
      msg = JSON.parse(event.data);
    } catch (e) {
      log('GeÃ§ersiz mesaj: ' + event.data);
      return;
    }
    switch (msg.type) {
      case 'ports-updated':
        updatePortSelects(msg.data);
        break;
      case 'aviyonik-connected':
        log(`Aviyonik baÄŸlandÄ±: ${msg.data}`);
        updateStatus(aviyonikStatus, 'connected');
        document.getElementById('connectAviyonikBtn').disabled = true;
        document.getElementById('disconnectAviyonikBtn').disabled = false;
        break;
      case 'aviyonik-disconnected':
        log('Aviyonik baÄŸlantÄ±sÄ± kesildi');
        updateStatus(aviyonikStatus, 'disconnected');
        document.getElementById('connectAviyonikBtn').disabled = false;
        document.getElementById('disconnectAviyonikBtn').disabled = true;
        break;
      case 'aviyonik-error':
        log(`Aviyonik hatasÄ±: ${msg.data}`);
        updateStatus(aviyonikStatus, 'disconnected');
        document.getElementById('connectAviyonikBtn').disabled = false;
        document.getElementById('disconnectAviyonikBtn').disabled = true;
        break;
      case 'aviyonik-data':
        lastAviyonikData = msg.data;
        updateTable(aviyonikTableBody, msg.data);
        updateRocketVisualization(msg.data);
        aviyonikPacketCount++;
        updateCounts();
        log(`Aviyonik: ${Object.keys(msg.data).length} parametre`);
        break;
      case 'gorev-connected':
        log(`GÃ¶rev YÃ¼kÃ¼ baÄŸlandÄ±: ${msg.data}`);
        updateStatus(gorevStatus, 'connected');
        document.getElementById('connectGorevBtn').disabled = true;
        document.getElementById('disconnectGorevBtn').disabled = false;
        break;
      case 'gorev-disconnected':
        log('GÃ¶rev YÃ¼kÃ¼ baÄŸlantÄ±sÄ± kesildi');
        updateStatus(gorevStatus, 'disconnected');
        document.getElementById('connectGorevBtn').disabled = false;
        document.getElementById('disconnectGorevBtn').disabled = true;
        break;
      case 'gorev-error':
        log(`GÃ¶rev YÃ¼kÃ¼ hatasÄ±: ${msg.data}`);
        updateStatus(gorevStatus, 'disconnected');
        document.getElementById('connectGorevBtn').disabled = false;
        document.getElementById('disconnectGorevBtn').disabled = true;
        break;
      case 'gorev-data':
        lastGorevData = msg.data;
        updateTable(gorevTableBody, msg.data);
        gorevPacketCount++;
        updateCounts();
        log(`GÃ¶rev YÃ¼kÃ¼: ${Object.keys(msg.data).length} parametre`);
        break;
      case 'hyi-connected':
        log(`HYÄ° baÄŸlandÄ±: ${msg.data}`);
        updateStatus(hyiStatus, 'connected');
        document.getElementById('connectHYIBtn').disabled = true;
        document.getElementById('disconnectHYIBtn').disabled = false;
        break;
      case 'hyi-disconnected':
        log('HYÄ° baÄŸlantÄ±sÄ± kesildi');
        updateStatus(hyiStatus, 'disconnected');
        document.getElementById('connectHYIBtn').disabled = false;
        document.getElementById('disconnectHYIBtn').disabled = true;
        break;
      case 'hyi-error':
        log(`HYÄ° hatasÄ±: ${msg.data}`);
        updateStatus(hyiStatus, 'disconnected');
        document.getElementById('connectHYIBtn').disabled = false;
        document.getElementById('disconnectHYIBtn').disabled = true;
        break;
      case 'hyi-sent':
        hyiSentCount++;
        updateCounts();
        log(`HYÄ° paketi gÃ¶nderildi! SayaÃ§: ${msg.data}`);
        break;
      case 'hyi-send-error':
        log(`HYÄ° gÃ¶nderim hatasÄ±: ${msg.data}`);
        break;
      default:
        break;
    }
  });
});

// Port seÃ§im listelerini gÃ¼ncelle
function updatePortSelects(ports) {
  const selects = [aviyonikPortSelect, gorevPortSelect, hyiPortSelect];
  selects.forEach(select => {
    const currentValue = select.value;
    select.innerHTML = '<option value="">Port seÃ§in...</option>';
    ports.forEach(port => {
      const option = document.createElement('option');
      option.value = port.path;
      option.textContent = `${port.path} (${port.manufacturer})`;
      select.appendChild(option);
    });
    if (currentValue) {
      select.value = currentValue;
    }
  });
  log(`${ports.length} port bulundu`);
}

// Button event listeners
document.getElementById('refreshPortsBtn').addEventListener('click', () => {
  socket.send(JSON.stringify({ type: 'refresh-ports' }));
  log('Port listesi yenileniyor...');
});

document.getElementById('connectAviyonikBtn').addEventListener('click', () => {
  const portPath = aviyonikPortSelect.value;
  if (portPath) {
    updateStatus(aviyonikStatus, 'connecting');
    socket.send(JSON.stringify({ type: 'connect-aviyonik', data: portPath }));
  } else {
    alert('LÃ¼tfen bir port seÃ§in');
  }
});

document.getElementById('disconnectAviyonikBtn').addEventListener('click', () => {
  socket.send(JSON.stringify({ type: 'disconnect-aviyonik' }));
});

document.getElementById('connectGorevBtn').addEventListener('click', () => {
  const portPath = gorevPortSelect.value;
  if (portPath) {
    updateStatus(gorevStatus, 'connecting');
    socket.send(JSON.stringify({ type: 'connect-gorev', data: portPath }));
  } else {
    alert('LÃ¼tfen bir port seÃ§in');
  }
});

document.getElementById('disconnectGorevBtn').addEventListener('click', () => {
  socket.send(JSON.stringify({ type: 'disconnect-gorev' }));
});

document.getElementById('connectHYIBtn').addEventListener('click', () => {
  const portPath = hyiPortSelect.value;
  if (portPath) {
    updateStatus(hyiStatus, 'connecting');
    socket.send(JSON.stringify({ type: 'connect-hyi', data: portPath }));
  } else {
    alert('LÃ¼tfen bir port seÃ§in');
  }
});

document.getElementById('disconnectHYIBtn').addEventListener('click', () => {
  socket.send(JSON.stringify({ type: 'disconnect-hyi' }));
});

// Parsing fonksiyonlarÄ±
function updateTable(tbody, data) {
  tbody.innerHTML = '';
  for (let key in data) {
    const tr = document.createElement('tr');
    const tdKey = document.createElement('td');
    tdKey.textContent = key;
    const tdVal = document.createElement('td');
    tdVal.textContent = data[key];
    tr.appendChild(tdKey);
    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }
}

</script>
</body>
</html>
